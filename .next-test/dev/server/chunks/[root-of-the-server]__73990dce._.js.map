{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HI/Documents/GitHub/buenasv2/app/api/auth/login/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { LoginInput } from '@/types/auth.types';\r\n\r\nexport const dynamic = 'force-dynamic';\r\n\r\nconst buckets: Map<string, { tokens: number; lastRefill: number }> = new Map();\r\nconst RATE_LIMIT_MAX = process.env.NODE_ENV === 'production' ? 5 : 1000;\r\nconst RATE_LIMIT_WINDOW_MS = 60_000;\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const body: LoginInput = await request.json();\r\n\r\n    // Validate required fields\r\n    if (!body.email || !body.password) {\r\n      return NextResponse.json(\r\n        { success: false, message: 'Email and password are required' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Get IP address and user agent\r\n    const ipAddress = request.headers.get('x-forwarded-for') || request.headers.get('x-real-ip') || undefined;\r\n    const userAgent = request.headers.get('user-agent') || undefined;\r\n\r\n    // Skip rate limiting in test environment\r\n    let bucket = { tokens: Number.MAX_SAFE_INTEGER, lastRefill: Date.now() };\r\n    if (process.env.NODE_ENV !== 'test') {\r\n      const key = `${ipAddress || 'unknown'}:${body.email}`;\r\n      const now = Date.now();\r\n      bucket = buckets.get(key) || { tokens: RATE_LIMIT_MAX, lastRefill: now };\r\n      const elapsed = now - bucket.lastRefill;\r\n      if (elapsed >= RATE_LIMIT_WINDOW_MS) {\r\n        bucket.tokens = RATE_LIMIT_MAX;\r\n        bucket.lastRefill = now;\r\n      }\r\n      if (bucket.tokens <= 0) {\r\n        return NextResponse.json(\r\n          { success: false, message: 'Too many attempts. Please try again later.' },\r\n          { status: 429 }\r\n        );\r\n      }\r\n      bucket.tokens -= 1;\r\n      buckets.set(key, bucket);\r\n    }\r\n\r\n    // Attempt login\r\n    const { authService } = await import('@/services/auth.service');\r\n    const result = await authService.login(body, ipAddress, userAgent);\r\n\r\n    if (!result.success) {\r\n      return NextResponse.json(result, { status: 401 });\r\n    }\r\n\r\n    // Set HTTP-only cookie with the token\r\n    const response = NextResponse.json(result, { status: 200 });\r\n\r\n    if (result.token) {\r\n      // Set cookie maxAge based on rememberMe: 30 days or 24 hours\r\n      const maxAge = body.rememberMe ? 60 * 60 * 24 * 30 : 60 * 60 * 24;\r\n\r\n      response.cookies.set('auth-token', result.token, {\r\n        httpOnly: true,\r\n        secure: process.env.NODE_ENV === 'production',\r\n        sameSite: 'strict', // Changed from 'lax' to 'strict' for better CSRF protection\r\n        maxAge,\r\n        path: '/',\r\n      });\r\n    }\r\n\r\n    return response;\r\n  } catch (error: any) {\r\n    console.error('Login error:', error);\r\n    return NextResponse.json(\r\n      { success: false, message: String(error?.message || 'An error occurred during login') },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;;AAGO,MAAM,UAAU;AAEvB,MAAM,UAA+D,IAAI;AACzE,MAAM,iBAAiB,sCAAwC,0BAAI;AACnE,MAAM,uBAAuB;AAEtB,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,OAAmB,MAAM,QAAQ,IAAI;QAE3C,2BAA2B;QAC3B,IAAI,CAAC,KAAK,KAAK,IAAI,CAAC,KAAK,QAAQ,EAAE;YACjC,OAAO,mLAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;gBAAO,SAAS;YAAkC,GAC7D;gBAAE,QAAQ;YAAI;QAElB;QAEA,gCAAgC;QAChC,MAAM,YAAY,QAAQ,OAAO,CAAC,GAAG,CAAC,sBAAsB,QAAQ,OAAO,CAAC,GAAG,CAAC,gBAAgB;QAChG,MAAM,YAAY,QAAQ,OAAO,CAAC,GAAG,CAAC,iBAAiB;QAEvD,yCAAyC;QACzC,IAAI,SAAS;YAAE,QAAQ,OAAO,gBAAgB;YAAE,YAAY,KAAK,GAAG;QAAG;QACvE,wCAAqC;YACnC,MAAM,MAAM,GAAG,aAAa,UAAU,CAAC,EAAE,KAAK,KAAK,EAAE;YACrD,MAAM,MAAM,KAAK,GAAG;YACpB,SAAS,QAAQ,GAAG,CAAC,QAAQ;gBAAE,QAAQ;gBAAgB,YAAY;YAAI;YACvE,MAAM,UAAU,MAAM,OAAO,UAAU;YACvC,IAAI,WAAW,sBAAsB;gBACnC,OAAO,MAAM,GAAG;gBAChB,OAAO,UAAU,GAAG;YACtB;YACA,IAAI,OAAO,MAAM,IAAI,GAAG;gBACtB,OAAO,mLAAY,CAAC,IAAI,CACtB;oBAAE,SAAS;oBAAO,SAAS;gBAA6C,GACxE;oBAAE,QAAQ;gBAAI;YAElB;YACA,OAAO,MAAM,IAAI;YACjB,QAAQ,GAAG,CAAC,KAAK;QACnB;QAEA,gBAAgB;QAChB,MAAM,EAAE,WAAW,EAAE,GAAG;QACxB,MAAM,SAAS,MAAM,YAAY,KAAK,CAAC,MAAM,WAAW;QAExD,IAAI,CAAC,OAAO,OAAO,EAAE;YACnB,OAAO,mLAAY,CAAC,IAAI,CAAC,QAAQ;gBAAE,QAAQ;YAAI;QACjD;QAEA,sCAAsC;QACtC,MAAM,WAAW,mLAAY,CAAC,IAAI,CAAC,QAAQ;YAAE,QAAQ;QAAI;QAEzD,IAAI,OAAO,KAAK,EAAE;YAChB,6DAA6D;YAC7D,MAAM,SAAS,KAAK,UAAU,GAAG,KAAK,KAAK,KAAK,KAAK,KAAK,KAAK;YAE/D,SAAS,OAAO,CAAC,GAAG,CAAC,cAAc,OAAO,KAAK,EAAE;gBAC/C,UAAU;gBACV,QAAQ,oDAAyB;gBACjC,UAAU;gBACV;gBACA,MAAM;YACR;QACF;QAEA,OAAO;IACT,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,gBAAgB;QAC9B,OAAO,mLAAY,CAAC,IAAI,CACtB;YAAE,SAAS;YAAO,SAAS,OAAO,OAAO,WAAW;QAAkC,GACtF;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}